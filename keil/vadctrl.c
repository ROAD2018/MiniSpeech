#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "Platform.h"
#include "recordctrl.h"
#include "vadctrl.h"
#include "flash.h"

typedef struct 
{
    int16_t  midd;       
    int16_t  nthr;       
    int16_t  zthr;       
    int32_t  sthr;       
} S_BACKGROUD_CTRL_HANDLE;  

typedef struct 
{
    uint32_t  u32BegAddr;
    uint32_t  u32EndAddr;
	uint32_t  u32CurAddr;
} S_VOICEADDR_CTRL_HANDLE;  

typedef struct 
{
    uint32_t  cmd;       
    uint32_t  frames;  	
    uint32_t  begaddr;  
    uint32_t  endaddr;	
} S_BLOCKADDR_CTRL_HANDLE;  

typedef struct 
{ 
    uint32_t  u32BegAddr;       
    uint32_t  u32EndAddr;             
} S_BOUNDADDR_CTRL_HANDLE;  

typedef struct
{
	float real;
	float img;
}complex;

typedef enum {
	E_DIRCT_RIGHT,
	E_DIRCT_UP,
	E_DIRCT_INCLINE,
    E_DIRCT_ERR
} DIRECTION;

volatile __align(4) float   f32RecFrmData[VAD_FRAME_LEN];
//volatile __align(4) char    i8FftBufData[sizeof(complex) * MFC_FFT_PRC];
//volatile __align(4) int8_t    i8FrqBufData[sizeof(uint32_t) * MFC_FRQ_MAX];

volatile static S_BACKGROUD_CTRL_HANDLE s_sBackgroudCtrlHandle;
volatile static S_VOICEADDR_CTRL_HANDLE s_sVoiceaddrCtrlHandle;
volatile static S_BLOCKADDR_CTRL_HANDLE s_sBlockaddrCtrlHandle;
volatile static S_BOUNDADDR_CTRL_HANDLE s_sBoundaddrCtrlHandle;

///*
//fun = @(i)((1-0.46) - 0.46*cos(2*i*pi/159))  80
const float MFC_HAM_FRAMES[VAD_FRAME_LEN]=
{
0.0800,0.0804,0.0814,0.0832,0.0857,0.0889,0.0929,0.0975,0.1028,0.1088,
0.1155,0.1228,0.1308,0.1394,0.1486,0.1585,0.1689,0.1800,0.1915,0.2037,
0.2163,0.2295,0.2432,0.2573,0.2718,0.2868,0.3022,0.3179,0.3340,0.3504,
0.3671,0.3841,0.4013,0.4187,0.4364,0.4542,0.4721,0.4901,0.5082,0.5264,
0.5445,0.5627,0.5808,0.5989,0.6169,0.6348,0.6525,0.6700,0.6873,0.7044,
0.7213,0.7378,0.7541,0.7700,0.7856,0.8007,0.8155,0.8298,0.8437,0.8571,
0.8701,0.8825,0.8943,0.9056,0.9164,0.9265,0.9361,0.9450,0.9533,0.9610,
0.9680,0.9743,0.9799,0.9849,0.9892,0.9927,0.9956,0.9978,0.9992,0.9999
};
//*/

/*
//fun = @(i)((1-0.46) - 0.46*cos(2*i*pi/159))  160
const float MFC_HAM_FRAMES[VAD_FRAME_LEN]=
{
    0.080000,0.080359,0.081436,0.083229,0.085735,0.088950,0.092869,0.097487,0.102796,0.108787,
	0.115451,0.122779,0.130758,0.139376,0.148619,0.158473,0.168924,0.179953,0.191545,0.203681,
	0.216342,0.229508,0.243159,0.257273,0.271829,0.286804,0.302174,0.317916,0.334004,0.350414,
	0.367119,0.384095,0.401314,0.418750,0.436375,0.454162,0.472083,0.490109,0.508214,0.526369,
	0.544544,0.562713,0.580846,0.598915,0.616893,0.634750,0.652460,0.669993,0.687324,0.704425,
	0.721269,0.737830,0.754082,0.770000,0.785559,0.800734,0.815502,0.829840,0.843726,0.857137,
	0.870053,0.882454,0.894320,0.905633,0.916375,0.926529,0.936080,0.945012,0.953312,0.960967,
	0.967964,0.974293,0.979944,0.984909,0.989178,0.992746,0.995607,0.997757,0.999192,0.999910,
	0.999910,0.999192,0.997757,0.995607,0.992746,0.989178,0.984909,0.979944,0.974293,0.967964,
	0.960967,0.953312,0.945012,0.936080,0.926529,0.916375,0.905633,0.894320,0.882454,0.870053,
	0.857137,0.843726,0.829840,0.815502,0.800734,0.785559,0.770000,0.754082,0.737830,0.721269,
	0.704425,0.687324,0.669993,0.652460,0.634750,0.616893,0.598915,0.580846,0.562713,0.544544,
	0.526369,0.508214,0.490109,0.472083,0.454162,0.436375,0.418750,0.401314,0.384095,0.367119,
	0.350414,0.334004,0.317916,0.302174,0.286804,0.271829,0.257273,0.243159,0.229508,0.216342,
	0.203681,0.191545,0.179953,0.168924,0.158473,0.148619,0.139376,0.130758,0.122779,0.115451,
	0.108787,0.102796,0.097487,0.092869,0.088950,0.085735,0.083229,0.081436,0.080359,0.080000
};
*/

/* 256
const int16_t MFC_BIT_REVSER[MFC_FFT_PRC]=
{
 0, 128, 64, 192, 32, 160,  96, 224, 16, 144, 80, 208, 48, 176, 112, 240,
 8, 136, 72, 200, 40, 168, 104, 232, 24, 152, 88, 216, 56, 184, 120, 248,
 4, 132, 68, 196, 36, 164, 100, 228, 20, 148, 84, 212, 52, 180, 116, 244,
12, 140, 76, 204, 44, 172, 108, 236, 28, 156, 92, 220, 60, 188, 124, 252,
 2, 130, 66, 194, 34, 162,  98, 226, 18, 146, 82, 210, 50, 178, 114, 242, 
10, 138, 74, 202, 42, 170, 106, 234, 26, 154, 90, 218, 58, 186, 122, 250, 
 6, 134, 70, 198, 38, 166, 102, 230, 22, 150, 86, 214, 54, 182, 118, 246, 
14, 142, 78, 206, 46, 174, 110, 238, 30, 158, 94, 222, 62, 190, 126, 254, 
 1, 129, 65, 193, 33, 161,  97, 225, 17, 145, 81, 209, 49, 177, 113, 241, 
 9, 137, 73, 201, 41, 169, 105, 233, 25, 153, 89, 217, 57, 185, 121, 249, 
 5, 133, 69, 197, 37, 165, 101, 229, 21, 149, 85, 213, 53, 181, 117, 245, 
13, 141, 77, 205, 45, 173, 109, 237, 29, 157, 93, 221, 61, 189, 125, 253, 
 3, 131, 67, 195, 35, 163,  99, 227, 19, 147, 83, 211, 51, 179, 115, 243, 
11, 139, 75, 203, 43, 171, 107, 235, 27, 155, 91, 219, 59, 187, 123, 251, 
 7, 135, 71, 199, 39, 167, 103, 231, 23, 151, 87, 215, 55, 183, 119, 247, 
15, 143, 79, 207, 47, 175, 111, 239, 31, 159, 95, 223, 63, 191, 127, 255
};
*/
const int16_t MFC_BIT_REVSER[MFC_FFT_PRC]=
{
 0, 256, 128, 384, 64, 320, 192, 448, 32, 288, 160, 416,  96, 352, 224, 480,
16, 272, 144, 400, 80, 336, 208, 464, 48, 304, 176, 432, 112, 368, 240, 496, 
 8, 264, 136, 392, 72, 328, 200, 456, 40, 296, 168, 424, 104, 360, 232, 488, 
24, 280, 152, 408, 88, 344, 216, 472, 56, 312, 184, 440, 120, 376, 248, 504,
 4, 260, 132, 388, 68, 324, 196, 452, 36, 292, 164, 420, 100, 356, 228, 484, 
20, 276, 148, 404, 84, 340, 212, 468, 52, 308, 180, 436, 116, 372, 244, 500, 
12, 268, 140, 396, 76, 332, 204, 460, 44, 300, 172, 428, 108, 364, 236, 492, 
28, 284, 156, 412, 92, 348, 220, 476, 60, 316, 188, 444, 124, 380, 252, 508, 
 2, 258, 130, 386, 66, 322, 194, 450, 34, 290, 162, 418,  98, 354, 226, 482, 
18, 274, 146, 402, 82, 338, 210, 466, 50, 306, 178, 434, 114, 370, 242, 498, 
10, 266, 138, 394, 74, 330, 202, 458, 42, 298, 170, 426, 106, 362, 234, 490, 
26, 282, 154, 410, 90, 346, 218, 474, 58, 314, 186, 442, 122, 378, 250, 506, 
 6, 262, 134, 390, 70, 326, 198, 454, 38, 294, 166, 422, 102, 358, 230, 486, 
22, 278, 150, 406, 86, 342, 214, 470, 54, 310, 182, 438, 118, 374, 246, 502, 
14, 270, 142, 398, 78, 334, 206, 462, 46, 302, 174, 430, 110, 366, 238, 494, 
30, 286, 158, 414, 94, 350, 222, 478, 62, 318, 190, 446, 126, 382, 254, 510, 
 1, 257, 129, 385, 65, 321, 193, 449, 33, 289, 161, 417,  97, 353, 225, 481, 
17, 273, 145, 401, 81, 337, 209, 465, 49, 305, 177, 433, 113, 369, 241, 497, 
 9, 265, 137, 393, 73, 329, 201, 457, 41, 297, 169, 425, 105, 361, 233, 489, 
25, 281, 153, 409, 89, 345, 217, 473, 57, 313, 185, 441, 121, 377, 249, 505, 
 5, 261, 133, 389, 69, 325, 197, 453, 37, 293, 165, 421, 101, 357, 229, 485, 
21, 277, 149, 405, 85, 341, 213, 469, 53, 309, 181, 437, 117, 373, 245, 501, 
13, 269, 141, 397, 77, 333, 205, 461, 45, 301, 173, 429, 109, 365, 237, 493, 
29, 285, 157, 413, 93, 349, 221, 477, 61, 317, 189, 445, 125, 381, 253, 509, 
 3, 259, 131, 387, 67, 323, 195, 451, 35, 291, 163, 419,  99, 355, 227, 483, 
19, 275, 147, 403, 83, 339, 211, 467, 51, 307, 179, 435, 115, 371, 243, 499, 
11, 267, 139, 395, 75, 331, 203, 459, 43, 299, 171, 427, 107, 363, 235, 491, 
27, 283, 155, 411, 91, 347, 219, 475, 59, 315, 187, 443, 123, 379, 251, 507, 
 7, 263, 135, 391, 71, 327, 199, 455, 39, 295, 167, 423, 103, 359, 231, 487, 
23, 279, 151, 407, 87, 343, 215, 471, 55, 311, 183, 439, 119, 375, 247, 503, 
15, 271, 143, 399, 79, 335, 207, 463, 47, 303, 175, 431, 111, 367, 239, 495, 
31, 287, 159, 415, 95, 351, 223, 479, 63, 319, 191, 447, 127, 383, 255, 511
};
/* 1024
const int16_t MFC_BIT_REVSER[MFC_FFT_PRC]=
  0, 512, 256, 768, 128, 640, 384, 896,  64, 576, 320, 832, 192, 704, 448,  960,
 32, 544, 288, 800, 160, 672, 416, 928,  96, 608, 352, 864, 224, 736, 480,  992, 
 16, 528, 272, 784, 144, 656, 400, 912,  80, 592, 336, 848, 208, 720, 464,  976, 
 48, 560, 304, 816, 176, 688, 432, 944, 112, 624, 368, 880, 240, 752, 496, 1008, 
  8, 520, 264, 776, 136, 648, 392, 904,  72, 584, 328, 840, 200, 712, 456,  968, 
 40, 552, 296, 808, 168, 680, 424, 936, 104, 616, 360, 872, 232, 744, 488, 1000, 
 24, 536, 280, 792, 152, 664, 408, 920,  88, 600, 344, 856, 216, 728, 472,  984, 
 56, 568, 312, 824, 184, 696, 440, 952, 120, 632, 376, 888, 248, 760, 504, 1016, 
  4, 516, 260, 772, 132, 644, 388, 900,  68, 580, 324, 836, 196, 708, 452,  964, 
 36, 548, 292, 804, 164, 676, 420, 932, 100, 612, 356, 868, 228, 740, 484,  996, 
 20, 532, 276, 788, 148, 660, 404, 916,  84, 596, 340, 852, 212, 724, 468,  980, 
 52, 564, 308, 820, 180, 692, 436, 948, 116, 628, 372, 884, 244, 756, 500, 1012, 
 12, 524, 268, 780, 140, 652, 396, 908,  76, 588, 332, 844, 204, 716, 460,  972, 
 44, 556, 300, 812, 172, 684, 428, 940, 108, 620, 364, 876, 236, 748, 492, 1004, 
 28, 540, 284, 796, 156, 668, 412, 924,  92, 604, 348, 860, 220, 732, 476,  988, 
 60, 572, 316, 828, 188, 700, 444, 956, 124, 636, 380, 892, 252, 764, 508, 1020, 
  2, 514, 258, 770, 130, 642, 386, 898,  66, 578, 322, 834, 194, 706, 450,  962, 
 34, 546, 290, 802, 162, 674, 418, 930,  98, 610, 354, 866, 226, 738, 482,  994, 
 18, 530, 274, 786, 146, 658, 402, 914,  82, 594, 338, 850, 210, 722, 466,  978, 
 50, 562, 306, 818, 178, 690, 434, 946, 114, 626, 370, 882, 242, 754, 498, 1010, 
 10, 522, 266, 778, 138, 650, 394, 906,  74, 586, 330, 842, 202, 714, 458,  970, 
 42, 554, 298, 810, 170, 682, 426, 938, 106, 618, 362, 874, 234, 746, 490, 1002, 
 26, 538, 282, 794, 154, 666, 410, 922,  90, 602, 346, 858, 218, 730, 474,  986, 
 58, 570, 314, 826, 186, 698, 442, 954, 122, 634, 378, 890, 250, 762, 506, 1018, 
  6, 518, 262, 774, 134, 646, 390, 902,  70, 582, 326, 838, 198, 710, 454,  966, 
 38, 550, 294, 806, 166, 678, 422, 934, 102, 614, 358, 870, 230, 742, 486,  998, 
 22, 534, 278, 790, 150, 662, 406, 918,  86, 598, 342, 854, 214, 726, 470,  982, 
 54, 566, 310, 822, 182, 694, 438, 950, 118, 630, 374, 886, 246, 758, 502, 1014, 
 14, 526, 270, 782, 142, 654, 398, 910,  78, 590, 334, 846, 206, 718, 462,  974, 
 46, 558, 302, 814, 174, 686, 430, 942, 110, 622, 366, 878, 238, 750, 494, 1006, 
 30, 542, 286, 798, 158, 670, 414, 926,  94, 606, 350, 862, 222, 734, 478,  990, 
 62, 574, 318, 830, 190, 702, 446, 958, 126, 638, 382, 894, 254, 766, 510, 1022, 
  1, 513, 257, 769, 129, 641, 385, 897,  65, 577, 321, 833, 193, 705, 449,  961, 
 33, 545, 289, 801, 161, 673, 417, 929,  97, 609, 353, 865, 225, 737, 481,  993, 
 17, 529, 273, 785, 145, 657, 401, 913,  81, 593, 337, 849, 209, 721, 465,  977, 
 49, 561, 305, 817, 177, 689, 433, 945, 113, 625, 369, 881, 241, 753, 497, 1009, 
  9, 521, 265, 777, 137, 649, 393, 905,  73, 585, 329, 841, 201, 713, 457,  969, 
 41, 553, 297, 809, 169, 681, 425, 937, 105, 617, 361, 873, 233, 745, 489, 1001, 
 25, 537, 281, 793, 153, 665, 409, 921,  89, 601, 345, 857, 217, 729, 473,  985, 
 57, 569, 313, 825, 185, 697, 441, 953, 121, 633, 377, 889, 249, 761, 505, 1017, 
  5, 517, 261, 773, 133, 645, 389, 901,  69, 581, 325, 837, 197, 709, 453,  965, 
 37, 549, 293, 805, 165, 677, 421, 933, 101, 613, 357, 869, 229, 741, 485,  997, 
 21, 533, 277, 789, 149, 661, 405, 917,  85, 597, 341, 853, 213, 725, 469,  981, 
 53, 565, 309, 821, 181, 693, 437, 949, 117, 629, 373, 885, 245, 757, 501, 1013, 
 13, 525, 269, 781, 141, 653, 397, 909,  77, 589, 333, 845, 205, 717, 461,  973, 
 45, 557, 301, 813, 173, 685, 429, 941, 109, 621, 365, 877, 237, 749, 493, 1005, 
 29, 541, 285, 797, 157, 669, 413, 925,  93, 605, 349, 861, 221, 733, 477,  989, 
 61, 573, 317, 829, 189, 701, 445, 957, 125, 637, 381, 893, 253, 765, 509, 1021, 
  3, 515, 259, 771, 131, 643, 387, 899,  67, 579, 323, 835, 195, 707, 451,  963, 
 35, 547, 291, 803, 163, 675, 419, 931,  99, 611, 355, 867, 227, 739, 483,  995, 
 19, 531, 275, 787, 147, 659, 403, 915,  83, 595, 339, 851, 211, 723, 467,  979, 
 51, 563, 307, 819, 179, 691, 435, 947, 115, 627, 371, 883, 243, 755, 499, 1011, 
 11, 523, 267, 779, 139, 651, 395, 907,  75, 587, 331, 843, 203, 715, 459,  971, 
 43, 555, 299, 811, 171, 683, 427, 939, 107, 619, 363, 875, 235, 747, 491, 1003, 
 27, 539, 283, 795, 155, 667, 411, 923,  91, 603, 347, 859, 219, 731, 475,  987, 
 59, 571, 315, 827, 187, 699, 443, 955, 123, 635, 379, 891, 251, 763, 507, 1019, 
  7, 519, 263, 775, 135, 647, 391, 903,  71, 583, 327, 839, 199, 711, 455,  967, 
 39, 551, 295, 807, 167, 679, 423, 935, 103, 615, 359, 871, 231, 743, 487,  999, 
 23, 535, 279, 791, 151, 663, 407, 919,  87, 599, 343, 855, 215, 727, 471,  983, 
 55, 567, 311, 823, 183, 695, 439, 951, 119, 631, 375, 887, 247, 759, 503, 1015, 
 15, 527, 271, 783, 143, 655, 399, 911,  79, 591, 335, 847, 207, 719, 463,  975, 
 47, 559, 303, 815, 175, 687, 431, 943, 111, 623, 367, 879, 239, 751, 495, 1007, 
 31, 543, 287, 799, 159, 671, 415, 927,  95, 607, 351, 863, 223, 735, 479,  991, 
 63, 575, 319, 831, 191, 703, 447, 959, 127, 639, 383, 895, 255, 767, 511, 1023
};
*/

const int16_t MFC_TRG_CENTER[MFC_TRI_NUM]=
{
/*
2,  4,  6,  8, 11, 13, 16, 19, 23, 26, 30, 34, 38, 43, 48, 54, 60, 66, 73, 81, 89, 98,107,117  //256-8000
4,  8, 12, 16, 21, 26, 32, 38, 45, 52, 59, 67, 76, 86, 96,107,119,132,146,161,177,195,214,234  //512-8000
8, 15, 24, 32, 42, 52, 64, 76, 89,103,118,134,152,171,192,214,238,264,292,322,354,390,427,468  //1024-8000
*/
	
10, 21, 32, 44, 56, 69, 83, 97,113,129,146,164,183,203,224,246,270,295,321,349,378,409,442,476 //1024-4000
};

/*x = 1;
for i = 0:9
    x = bitshift(1,i);
    y = x - 1;
    for j = 0:y
        coef(i+1, 2*j+1) = cos(j*pi/x);
        coef(i+1, 2*j+2) = -sin(j*pi/x);
    end
end
*/
const float MFC_FFT_COFFIC[]=
{
1.000000,0.000000,
1.000000,0.000000,0.000000,-1.000000,
1.000000,0.000000,0.707107,-0.707107,0.000000,-1.000000,-0.707107,-0.707107, 
1.000000,0.000000,0.923880,-0.382683,0.707107,-0.707107,0.382683,-0.923880,0.000000,-1.000000,-0.382683,-0.923880,-0.707107,-0.707107,-0.923880,-0.382683,
1.000000,0.000000,0.980785,-0.195090,0.923880,-0.382683,0.831470,-0.555570,0.707107,-0.707107,0.555570,-0.831470,0.382683,-0.923880,0.195090,-0.980785,0.000000,-1.000000,-0.195090,-0.980785,-0.382683,-0.923880,-0.555570,-0.831470,-0.707107,-0.707107,-0.831470,-0.555570,-0.923880,-0.382683,-0.980785,-0.195090,
1.000000,0.000000,0.995185,-0.098017,0.980785,-0.195090,0.956940,-0.290285,0.923880,-0.382683,0.881921,-0.471397,0.831470,-0.555570,0.773010,-0.634393,0.707107,-0.707107,0.634393,-0.773010,0.555570,-0.831470,0.471397,-0.881921,0.382683,-0.923880,0.290285,-0.956940,0.195090,-0.980785,0.098017,-0.995185,0.000000,-1.000000,-0.098017,-0.995185,-0.195090,-0.980785,-0.290285,-0.956940,-0.382683,-0.923880,-0.471397,-0.881921,-0.555570,-0.831470,-0.634393,-0.773010,-0.707107,-0.707107,-0.773010,-0.634393,-0.831470,-0.555570,-0.881921,-0.471397,-0.923880,-0.382683,-0.956940,-0.290285,-0.980785,-0.195090,-0.995185,-0.098017,
1.000000,0.000000,0.998795,-0.049068,0.995185,-0.098017,0.989177,-0.146730,0.980785,-0.195090,0.970031,-0.242980,0.956940,-0.290285,0.941544,-0.336890,0.923880,-0.382683,0.903989,-0.427555,0.881921,-0.471397,0.857729,-0.514103,0.831470,-0.555570,0.803208,-0.595699,0.773010,-0.634393,0.740951,-0.671559,0.707107,-0.707107,0.671559,-0.740951,0.634393,-0.773010,0.595699,-0.803208,0.555570,-0.831470,0.514103,-0.857729,0.471397,-0.881921,0.427555,-0.903989,0.382683,-0.923880,0.336890,-0.941544,0.290285,-0.956940,0.242980,-0.970031,0.195090,-0.980785,0.146730,-0.989177,0.098017,-0.995185,0.049068,-0.998795,0.000000,-1.000000,-0.049068,-0.998795,-0.098017,-0.995185,-0.146730,-0.989177,-0.195090,-0.980785,-0.242980,-0.970031,-0.290285,-0.956940,-0.336890,-0.941544,-0.382683,-0.923880,-0.427555,-0.903989,-0.471397,-0.881921,-0.514103,-0.857729,-0.555570,-0.831470,-0.595699,-0.803208,-0.634393,-0.773010,-0.671559,-0.740951,-0.707107,-0.707107,-0.740951,-0.671559,-0.773010,-0.634393,-0.803208,-0.595699,-0.831470,-0.555570,-0.857729,-0.514103,-0.881921,-0.471397,-0.903989,-0.427555,-0.923880,-0.382683,-0.941544,-0.336890,-0.956940,-0.290285,-0.970031,-0.242980,-0.980785,-0.195090,-0.989177,-0.146730,-0.995185,-0.098017,-0.998795,-0.049068,
1.000000,0.000000,0.999699,-0.024541,0.998795,-0.049068,0.997290,-0.073565,0.995185,-0.098017,0.992480,-0.122411,0.989177,-0.146730,0.985278,-0.170962,0.980785,-0.195090,0.975702,-0.219101,0.970031,-0.242980,0.963776,-0.266713,0.956940,-0.290285,0.949528,-0.313682,0.941544,-0.336890,0.932993,-0.359895,0.923880,-0.382683,0.914210,-0.405241,0.903989,-0.427555,0.893224,-0.449611,0.881921,-0.471397,0.870087,-0.492898,0.857729,-0.514103,0.844854,-0.534998,0.831470,-0.555570,0.817585,-0.575808,0.803208,-0.595699,0.788346,-0.615232,0.773010,-0.634393,0.757209,-0.653173,0.740951,-0.671559,0.724247,-0.689541,0.707107,-0.707107,0.689541,-0.724247,0.671559,-0.740951,0.653173,-0.757209,0.634393,-0.773010,0.615232,-0.788346,0.595699,-0.803208,0.575808,-0.817585,0.555570,-0.831470,0.534998,-0.844854,0.514103,-0.857729,0.492898,-0.870087,0.471397,-0.881921,0.449611,-0.893224,0.427555,-0.903989,0.405241,-0.914210,0.382683,-0.923880,0.359895,-0.932993,0.336890,-0.941544,0.313682,-0.949528,0.290285,-0.956940,0.266713,-0.963776,0.242980,-0.970031,0.219101,-0.975702,0.195090,-0.980785,0.170962,-0.985278,0.146730,-0.989177,0.122411,-0.992480,0.098017,-0.995185,0.073565,-0.997290,0.049068,-0.998795,0.024541,-0.999699,0.000000,-1.000000,-0.024541,-0.999699,-0.049068,-0.998795,-0.073565,-0.997290,-0.098017,-0.995185,-0.122411,-0.992480,-0.146730,-0.989177,-0.170962,-0.985278,-0.195090,-0.980785,-0.219101,-0.975702,-0.242980,-0.970031,-0.266713,-0.963776,-0.290285,-0.956940,-0.313682,-0.949528,-0.336890,-0.941544,-0.359895,-0.932993,-0.382683,-0.923880,-0.405241,-0.914210,-0.427555,-0.903989,-0.449611,-0.893224,-0.471397,-0.881921,-0.492898,-0.870087,-0.514103,-0.857729,-0.534998,-0.844854,-0.555570,-0.831470,-0.575808,-0.817585,-0.595699,-0.803208,-0.615232,-0.788346,-0.634393,-0.773010,-0.653173,-0.757209,-0.671559,-0.740951,-0.689541,-0.724247,-0.707107,-0.707107,-0.724247,-0.689541,-0.740951,-0.671559,-0.757209,-0.653173,-0.773010,-0.634393,-0.788346,-0.615232,-0.803208,-0.595699,-0.817585,-0.575808,-0.831470,-0.555570,-0.844854,-0.534998,-0.857729,-0.514103,-0.870087,-0.492898,-0.881921,-0.471397,-0.893224,-0.449611,-0.903989,-0.427555,-0.914210,-0.405241,-0.923880,-0.382683,-0.932993,-0.359895,-0.941544,-0.336890,-0.949528,-0.313682,-0.956940,-0.290285,-0.963776,-0.266713,-0.970031,-0.242980,-0.975702,-0.219101,-0.980785,-0.195090,-0.985278,-0.170962,-0.989177,-0.146730,-0.992480,-0.122411,-0.995185,-0.098017,-0.997290,-0.073565,-0.998795,-0.049068,-0.999699,-0.024541, 
1.000000,0.000000,0.999925,-0.012272,0.999699,-0.024541,0.999322,-0.036807,0.998795,-0.049068,0.998118,-0.061321,0.997290,-0.073565,0.996313,-0.085797,0.995185,-0.098017,0.993907,-0.110222,0.992480,-0.122411,0.990903,-0.134581,0.989177,-0.146730,0.987301,-0.158858,0.985278,-0.170962,0.983105,-0.183040,0.980785,-0.195090,0.978317,-0.207111,0.975702,-0.219101,0.972940,-0.231058,0.970031,-0.242980,0.966976,-0.254866,0.963776,-0.266713,0.960431,-0.278520,0.956940,-0.290285,0.953306,-0.302006,0.949528,-0.313682,0.945607,-0.325310,0.941544,-0.336890,0.937339,-0.348419,0.932993,-0.359895,0.928506,-0.371317,0.923880,-0.382683,0.919114,-0.393992,0.914210,-0.405241,0.909168,-0.416430,0.903989,-0.427555,0.898674,-0.438616,0.893224,-0.449611,0.887640,-0.460539,0.881921,-0.471397,0.876070,-0.482184,0.870087,-0.492898,0.863973,-0.503538,0.857729,-0.514103,0.851355,-0.524590,0.844854,-0.534998,0.838225,-0.545325,0.831470,-0.555570,0.824589,-0.565732,0.817585,-0.575808,0.810457,-0.585798,0.803208,-0.595699,0.795837,-0.605511,0.788346,-0.615232,0.780737,-0.624859,0.773010,-0.634393,0.765167,-0.643832,0.757209,-0.653173,0.749136,-0.662416,0.740951,-0.671559,0.732654,-0.680601,0.724247,-0.689541,0.715731,-0.698376,0.707107,-0.707107,0.698376,-0.715731,0.689541,-0.724247,0.680601,-0.732654,0.671559,-0.740951,0.662416,-0.749136,0.653173,-0.757209,0.643832,-0.765167,0.634393,-0.773010,0.624859,-0.780737,0.615232,-0.788346,0.605511,-0.795837,0.595699,-0.803208,0.585798,-0.810457,0.575808,-0.817585,0.565732,-0.824589,0.555570,-0.831470,0.545325,-0.838225,0.534998,-0.844854,0.524590,-0.851355,0.514103,-0.857729,0.503538,-0.863973,0.492898,-0.870087,0.482184,-0.876070,0.471397,-0.881921,0.460539,-0.887640,0.449611,-0.893224,0.438616,-0.898674,0.427555,-0.903989,0.416430,-0.909168,0.405241,-0.914210,0.393992,-0.919114,0.382683,-0.923880,0.371317,-0.928506,0.359895,-0.932993,0.348419,-0.937339,0.336890,-0.941544,0.325310,-0.945607,0.313682,-0.949528,0.302006,-0.953306,0.290285,-0.956940,0.278520,-0.960431,0.266713,-0.963776,0.254866,-0.966976,0.242980,-0.970031,0.231058,-0.972940,0.219101,-0.975702,0.207111,-0.978317,0.195090,-0.980785,0.183040,-0.983105,0.170962,-0.985278,0.158858,-0.987301,0.146730,-0.989177,0.134581,-0.990903,0.122411,-0.992480,0.110222,-0.993907,0.098017,-0.995185,0.085797,-0.996313,0.073565,-0.997290,0.061321,-0.998118,0.049068,-0.998795,0.036807,-0.999322,0.024541,-0.999699,0.012272,-0.999925,0.000000,-1.000000,-0.012272,-0.999925,-0.024541,-0.999699,-0.036807,-0.999322,-0.049068,-0.998795,-0.061321,-0.998118,-0.073565,-0.997290,-0.085797,-0.996313,-0.098017,-0.995185,-0.110222,-0.993907,-0.122411,-0.992480,-0.134581,-0.990903,-0.146730,-0.989177,-0.158858,-0.987301,-0.170962,-0.985278,-0.183040,-0.983105,-0.195090,-0.980785,-0.207111,-0.978317,-0.219101,-0.975702,-0.231058,-0.972940,-0.242980,-0.970031,-0.254866,-0.966976,-0.266713,-0.963776,-0.278520,-0.960431,-0.290285,-0.956940,-0.302006,-0.953306,-0.313682,-0.949528,-0.325310,-0.945607,-0.336890,-0.941544,-0.348419,-0.937339,-0.359895,-0.932993,-0.371317,-0.928506,-0.382683,-0.923880,-0.393992,-0.919114,-0.405241,-0.914210,-0.416430,-0.909168,-0.427555,-0.903989,-0.438616,-0.898674,-0.449611,-0.893224,-0.460539,-0.887640,-0.471397,-0.881921,-0.482184,-0.876070,-0.492898,-0.870087,-0.503538,-0.863973,-0.514103,-0.857729,-0.524590,-0.851355,-0.534998,-0.844854,-0.545325,-0.838225,-0.555570,-0.831470,-0.565732,-0.824589,-0.575808,-0.817585,-0.585798,-0.810457,-0.595699,-0.803208,-0.605511,-0.795837,-0.615232,-0.788346,-0.624859,-0.780737,-0.634393,-0.773010,-0.643832,-0.765167,-0.653173,-0.757209,-0.662416,-0.749136,-0.671559,-0.740951,-0.680601,-0.732654,-0.689541,-0.724247,-0.698376,-0.715731,-0.707107,-0.707107,-0.715731,-0.698376,-0.724247,-0.689541,-0.732654,-0.680601,-0.740951,-0.671559,-0.749136,-0.662416,-0.757209,-0.653173,-0.765167,-0.643832,-0.773010,-0.634393,-0.780737,-0.624859,-0.788346,-0.615232,-0.795837,-0.605511,-0.803208,-0.595699,-0.810457,-0.585798,-0.817585,-0.575808,-0.824589,-0.565732,-0.831470,-0.555570,-0.838225,-0.545325,-0.844854,-0.534998,-0.851355,-0.524590,-0.857729,-0.514103,-0.863973,-0.503538,-0.870087,-0.492898,-0.876070,-0.482184,-0.881921,-0.471397,-0.887640,-0.460539,-0.893224,-0.449611,-0.898674,-0.438616,-0.903989,-0.427555,-0.909168,-0.416430,-0.914210,-0.405241,-0.919114,-0.393992,-0.923880,-0.382683,-0.928506,-0.371317,-0.932993,-0.359895,-0.937339,-0.348419,-0.941544,-0.336890,-0.945607,-0.325310,-0.949528,-0.313682,-0.953306,-0.302006,-0.956940,-0.290285,-0.960431,-0.278520,-0.963776,-0.266713,-0.966976,-0.254866,-0.970031,-0.242980,-0.972940,-0.231058,-0.975702,-0.219101,-0.978317,-0.207111,-0.980785,-0.195090,-0.983105,-0.183040,-0.985278,-0.170962,-0.987301,-0.158858,-0.989177,-0.146730,-0.990903,-0.134581,-0.992480,-0.122411,-0.993907,-0.110222,-0.995185,-0.098017,-0.996313,-0.085797,-0.997290,-0.073565,-0.998118,-0.061321,-0.998795,-0.049068,-0.999322,-0.036807,-0.999699,-0.024541,-0.999925,-0.012272,
1.000000,0.000000,0.999981,-0.006136,0.999925,-0.012272,0.999831,-0.018407,0.999699,-0.024541,0.999529,-0.030675,0.999322,-0.036807,0.999078,-0.042938,0.998795,-0.049068,0.998476,-0.055195,0.998118,-0.061321,0.997723,-0.067444,0.997290,-0.073565,0.996820,-0.079682,0.996313,-0.085797,0.995767,-0.091909,0.995185,-0.098017,0.994565,-0.104122,0.993907,-0.110222,0.993212,-0.116319,0.992480,-0.122411,0.991710,-0.128498,0.990903,-0.134581,0.990058,-0.140658,0.989177,-0.146730,0.988258,-0.152797,0.987301,-0.158858,0.986308,-0.164913,0.985278,-0.170962,0.984210,-0.177004,0.983105,-0.183040,0.981964,-0.189069,0.980785,-0.195090,0.979570,-0.201105,0.978317,-0.207111,0.977028,-0.213110,0.975702,-0.219101,0.974339,-0.225084,0.972940,-0.231058,0.971504,-0.237024,0.970031,-0.242980,0.968522,-0.248928,0.966976,-0.254866,0.965394,-0.260794,0.963776,-0.266713,0.962121,-0.272621,0.960431,-0.278520,0.958703,-0.284408,0.956940,-0.290285,0.955141,-0.296151,0.953306,-0.302006,0.951435,-0.307850,0.949528,-0.313682,0.947586,-0.319502,0.945607,-0.325310,0.943593,-0.331106,0.941544,-0.336890,0.939459,-0.342661,0.937339,-0.348419,0.935184,-0.354164,0.932993,-0.359895,0.930767,-0.365613,0.928506,-0.371317,0.926210,-0.377007,0.923880,-0.382683,0.921514,-0.388345,0.919114,-0.393992,0.916679,-0.399624,0.914210,-0.405241,0.911706,-0.410843,0.909168,-0.416430,0.906596,-0.422000,0.903989,-0.427555,0.901349,-0.433094,0.898674,-0.438616,0.895966,-0.444122,0.893224,-0.449611,0.890449,-0.455084,0.887640,-0.460539,0.884797,-0.465976,0.881921,-0.471397,0.879012,-0.476799,0.876070,-0.482184,0.873095,-0.487550,0.870087,-0.492898,0.867046,-0.498228,0.863973,-0.503538,0.860867,-0.508830,0.857729,-0.514103,0.854558,-0.519356,0.851355,-0.524590,0.848120,-0.529804,0.844854,-0.534998,0.841555,-0.540171,0.838225,-0.545325,0.834863,-0.550458,0.831470,-0.555570,0.828045,-0.560662,0.824589,-0.565732,0.821103,-0.570781,0.817585,-0.575808,0.814036,-0.580814,0.810457,-0.585798,0.806848,-0.590760,0.803208,-0.595699,0.799537,-0.600616,0.795837,-0.605511,0.792107,-0.610383,0.788346,-0.615232,0.784557,-0.620057,0.780737,-0.624859,0.776888,-0.629638,0.773010,-0.634393,0.769103,-0.639124,0.765167,-0.643832,0.761202,-0.648514,0.757209,-0.653173,0.753187,-0.657807,0.749136,-0.662416,0.745058,-0.667000,0.740951,-0.671559,0.736817,-0.676093,0.732654,-0.680601,0.728464,-0.685084,0.724247,-0.689541,0.720003,-0.693971,0.715731,-0.698376,0.711432,-0.702755,0.707107,-0.707107,0.702755,-0.711432,0.698376,-0.715731,0.693971,-0.720003,0.689541,-0.724247,0.685084,-0.728464,0.680601,-0.732654,0.676093,-0.736817,0.671559,-0.740951,0.667000,-0.745058,0.662416,-0.749136,0.657807,-0.753187,0.653173,-0.757209,0.648514,-0.761202,0.643832,-0.765167,0.639124,-0.769103,0.634393,-0.773010,0.629638,-0.776888,0.624859,-0.780737,0.620057,-0.784557,0.615232,-0.788346,0.610383,-0.792107,0.605511,-0.795837,0.600616,-0.799537,0.595699,-0.803208,0.590760,-0.806848,0.585798,-0.810457,0.580814,-0.814036,0.575808,-0.817585,0.570781,-0.821103,0.565732,-0.824589,0.560662,-0.828045,0.555570,-0.831470,0.550458,-0.834863,0.545325,-0.838225,0.540171,-0.841555,0.534998,-0.844854,0.529804,-0.848120,0.524590,-0.851355,0.519356,-0.854558,0.514103,-0.857729,0.508830,-0.860867,0.503538,-0.863973,0.498228,-0.867046,0.492898,-0.870087,0.487550,-0.873095,0.482184,-0.876070,0.476799,-0.879012,0.471397,-0.881921,0.465976,-0.884797,0.460539,-0.887640,0.455084,-0.890449,0.449611,-0.893224,0.444122,-0.895966,0.438616,-0.898674,0.433094,-0.901349,0.427555,-0.903989,0.422000,-0.906596,0.416430,-0.909168,0.410843,-0.911706,0.405241,-0.914210,0.399624,-0.916679,0.393992,-0.919114,0.388345,-0.921514,0.382683,-0.923880,0.377007,-0.926210,0.371317,-0.928506,0.365613,-0.930767,0.359895,-0.932993,0.354164,-0.935184,0.348419,-0.937339,0.342661,-0.939459,0.336890,-0.941544,0.331106,-0.943593,0.325310,-0.945607,0.319502,-0.947586,0.313682,-0.949528,0.307850,-0.951435,0.302006,-0.953306,0.296151,-0.955141,0.290285,-0.956940,0.284408,-0.958703,0.278520,-0.960431,0.272621,-0.962121,0.266713,-0.963776,0.260794,-0.965394,0.254866,-0.966976,0.248928,-0.968522,0.242980,-0.970031,0.237024,-0.971504,0.231058,-0.972940,0.225084,-0.974339,0.219101,-0.975702,0.213110,-0.977028,0.207111,-0.978317,0.201105,-0.979570,0.195090,-0.980785,0.189069,-0.981964,0.183040,-0.983105,0.177004,-0.984210,0.170962,-0.985278,0.164913,-0.986308,0.158858,-0.987301,0.152797,-0.988258,0.146730,-0.989177,0.140658,-0.990058,0.134581,-0.990903,0.128498,-0.991710,0.122411,-0.992480,0.116319,-0.993212,0.110222,-0.993907,0.104122,-0.994565,0.098017,-0.995185,0.091909,-0.995767,0.085797,-0.996313,0.079682,-0.996820,0.073565,-0.997290,0.067444,-0.997723,0.061321,-0.998118,0.055195,-0.998476,0.049068,-0.998795,0.042938,-0.999078,0.036807,-0.999322,0.030675,-0.999529,0.024541,-0.999699,0.018407,-0.999831,0.012272,-0.999925,0.006136,-0.999981,0.000000,-1.000000,-0.006136,-0.999981,-0.012272,-0.999925,-0.018407,-0.999831,-0.024541,-0.999699,-0.030675,-0.999529,-0.036807,-0.999322,-0.042938,-0.999078,-0.049068,-0.998795,-0.055195,-0.998476,-0.061321,-0.998118,-0.067444,-0.997723,-0.073565,-0.997290,-0.079682,-0.996820,-0.085797,-0.996313,-0.091909,-0.995767,-0.098017,-0.995185,-0.104122,-0.994565,-0.110222,-0.993907,-0.116319,-0.993212,-0.122411,-0.992480,-0.128498,-0.991710,-0.134581,-0.990903,-0.140658,-0.990058,-0.146730,-0.989177,-0.152797,-0.988258,-0.158858,-0.987301,-0.164913,-0.986308,-0.170962,-0.985278,-0.177004,-0.984210,-0.183040,-0.983105,-0.189069,-0.981964,-0.195090,-0.980785,-0.201105,-0.979570,-0.207111,-0.978317,-0.213110,-0.977028,-0.219101,-0.975702,-0.225084,-0.974339,-0.231058,-0.972940,-0.237024,-0.971504,-0.242980,-0.970031,-0.248928,-0.968522,-0.254866,-0.966976,-0.260794,-0.965394,-0.266713,-0.963776,-0.272621,-0.962121,-0.278520,-0.960431,-0.284408,-0.958703,-0.290285,-0.956940,-0.296151,-0.955141,-0.302006,-0.953306,-0.307850,-0.951435,-0.313682,-0.949528,-0.319502,-0.947586,-0.325310,-0.945607,-0.331106,-0.943593,-0.336890,-0.941544,-0.342661,-0.939459,-0.348419,-0.937339,-0.354164,-0.935184,-0.359895,-0.932993,-0.365613,-0.930767,-0.371317,-0.928506,-0.377007,-0.926210,-0.382683,-0.923880,-0.388345,-0.921514,-0.393992,-0.919114,-0.399624,-0.916679,-0.405241,-0.914210,-0.410843,-0.911706,-0.416430,-0.909168,-0.422000,-0.906596,-0.427555,-0.903989,-0.433094,-0.901349,-0.438616,-0.898674,-0.444122,-0.895966,-0.449611,-0.893224,-0.455084,-0.890449,-0.460539,-0.887640,-0.465976,-0.884797,-0.471397,-0.881921,-0.476799,-0.879012,-0.482184,-0.876070,-0.487550,-0.873095,-0.492898,-0.870087,-0.498228,-0.867046,-0.503538,-0.863973,-0.508830,-0.860867,-0.514103,-0.857729,-0.519356,-0.854558,-0.524590,-0.851355,-0.529804,-0.848120,-0.534998,-0.844854,-0.540171,-0.841555,-0.545325,-0.838225,-0.550458,-0.834863,-0.555570,-0.831470,-0.560662,-0.828045,-0.565732,-0.824589,-0.570781,-0.821103,-0.575808,-0.817585,-0.580814,-0.814036,-0.585798,-0.810457,-0.590760,-0.806848,-0.595699,-0.803208,-0.600616,-0.799537,-0.605511,-0.795837,-0.610383,-0.792107,-0.615232,-0.788346,-0.620057,-0.784557,-0.624859,-0.780737,-0.629638,-0.776888,-0.634393,-0.773010,-0.639124,-0.769103,-0.643832,-0.765167,-0.648514,-0.761202,-0.653173,-0.757209,-0.657807,-0.753187,-0.662416,-0.749136,-0.667000,-0.745058,-0.671559,-0.740951,-0.676093,-0.736817,-0.680601,-0.732654,-0.685084,-0.728464,-0.689541,-0.724247,-0.693971,-0.720003,-0.698376,-0.715731,-0.702755,-0.711432,-0.707107,-0.707107,-0.711432,-0.702755,-0.715731,-0.698376,-0.720003,-0.693971,-0.724247,-0.689541,-0.728464,-0.685084,-0.732654,-0.680601,-0.736817,-0.676093,-0.740951,-0.671559,-0.745058,-0.667000,-0.749136,-0.662416,-0.753187,-0.657807,-0.757209,-0.653173,-0.761202,-0.648514,-0.765167,-0.643832,-0.769103,-0.639124,-0.773010,-0.634393,-0.776888,-0.629638,-0.780737,-0.624859,-0.784557,-0.620057,-0.788346,-0.615232,-0.792107,-0.610383,-0.795837,-0.605511,-0.799537,-0.600616,-0.803208,-0.595699,-0.806848,-0.590760,-0.810457,-0.585798,-0.814036,-0.580814,-0.817585,-0.575808,-0.821103,-0.570781,-0.824589,-0.565732,-0.828045,-0.560662,-0.831470,-0.555570,-0.834863,-0.550458,-0.838225,-0.545325,-0.841555,-0.540171,-0.844854,-0.534998,-0.848120,-0.529804,-0.851355,-0.524590,-0.854558,-0.519356,-0.857729,-0.514103,-0.860867,-0.508830,-0.863973,-0.503538,-0.867046,-0.498228,-0.870087,-0.492898,-0.873095,-0.487550,-0.876070,-0.482184,-0.879012,-0.476799,-0.881921,-0.471397,-0.884797,-0.465976,-0.887640,-0.460539,-0.890449,-0.455084,-0.893224,-0.449611,-0.895966,-0.444122,-0.898674,-0.438616,-0.901349,-0.433094,-0.903989,-0.427555,-0.906596,-0.422000,-0.909168,-0.416430,-0.911706,-0.410843,-0.914210,-0.405241,-0.916679,-0.399624,-0.919114,-0.393992,-0.921514,-0.388345,-0.923880,-0.382683,-0.926210,-0.377007,-0.928506,-0.371317,-0.930767,-0.365613,-0.932993,-0.359895,-0.935184,-0.354164,-0.937339,-0.348419,-0.939459,-0.342661,-0.941544,-0.336890,-0.943593,-0.331106,-0.945607,-0.325310,-0.947586,-0.319502,-0.949528,-0.313682,-0.951435,-0.307850,-0.953306,-0.302006,-0.955141,-0.296151,-0.956940,-0.290285,-0.958703,-0.284408,-0.960431,-0.278520,-0.962121,-0.272621,-0.963776,-0.266713,-0.965394,-0.260794,-0.966976,-0.254866,-0.968522,-0.248928,-0.970031,-0.242980,-0.971504,-0.237024,-0.972940,-0.231058,-0.974339,-0.225084,-0.975702,-0.219101,-0.977028,-0.213110,-0.978317,-0.207111,-0.979570,-0.201105,-0.980785,-0.195090,-0.981964,-0.189069,-0.983105,-0.183040,-0.984210,-0.177004,-0.985278,-0.170962,-0.986308,-0.164913,-0.987301,-0.158858,-0.988258,-0.152797,-0.989177,-0.146730,-0.990058,-0.140658,-0.990903,-0.134581,-0.991710,-0.128498,-0.992480,-0.122411,-0.993212,-0.116319,-0.993907,-0.110222,-0.994565,-0.104122,-0.995185,-0.098017,-0.995767,-0.091909,-0.996313,-0.085797,-0.996820,-0.079682,-0.997290,-0.073565,-0.997723,-0.067444,-0.998118,-0.061321,-0.998476,-0.055195,-0.998795,-0.049068,-0.999078,-0.042938,-0.999322,-0.036807,-0.999529,-0.030675,-0.999699,-0.024541,-0.999831,-0.018407,-0.999925,-0.012272,-0.999981,-0.006136 
};

//fun = @(i,j)(sqrt(2.0f/MFC_TRI_NUM) * cos((j-0.5f) * i * PI / MFC_TRI_NUM)
const float MFC_COS_TRGCNT[MFC_ORD_NUM][MFC_TRI_NUM]=
{
    {0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29, 0.29},
    {0.29, 0.29, 0.28, 0.27, 0.26, 0.24, 0.22, 0.19, 0.16, 0.13, 0.09, 0.06, 0.02,-0.02,-0.06,-0.09,-0.13,-0.16,-0.19,-0.22,-0.24,-0.26,-0.27,-0.28},
    {0.29, 0.29, 0.27, 0.23, 0.18, 0.11, 0.04,-0.04,-0.11,-0.18,-0.23,-0.27,-0.29,-0.29,-0.27,-0.23,-0.18,-0.11,-0.04, 0.04, 0.11, 0.18, 0.23, 0.27},
    {0.28, 0.28, 0.24, 0.16, 0.06,-0.06,-0.16,-0.24,-0.28,-0.28,-0.24,-0.16,-0.06, 0.06, 0.16, 0.24, 0.28, 0.28, 0.24, 0.16, 0.06,-0.06,-0.16,-0.24},
    {0.28, 0.28, 0.20, 0.07,-0.07,-0.20,-0.28,-0.28,-0.20,-0.07, 0.07, 0.20, 0.28, 0.28, 0.20, 0.07,-0.07,-0.20,-0.28,-0.28,-0.20,-0.07, 0.07, 0.20},
    {0.27, 0.27, 0.16,-0.02,-0.19,-0.28,-0.26,-0.13, 0.06, 0.22, 0.29, 0.24, 0.09,-0.09,-0.24,-0.29,-0.22,-0.06, 0.13, 0.26, 0.28, 0.19, 0.02,-0.16},
    {0.27, 0.27, 0.11,-0.11,-0.27,-0.27,-0.11, 0.11, 0.27, 0.27, 0.11,-0.11,-0.27,-0.27,-0.11, 0.11, 0.27, 0.27, 0.11,-0.11,-0.27,-0.27,-0.11, 0.11},
    {0.26, 0.26, 0.06,-0.19,-0.29,-0.16, 0.09, 0.27, 0.24, 0.02,-0.22,-0.28,-0.13, 0.13, 0.28, 0.22,-0.02,-0.24,-0.27,-0.09, 0.16, 0.29, 0.19,-0.06},
    {0.25, 0.25, 0.00,-0.25,-0.25,-0.00, 0.25, 0.25, 0.00,-0.25,-0.25,-0.00, 0.25, 0.25, 0.00,-0.25,-0.25, 0.00, 0.25, 0.25, 0.00,-0.25,-0.25, 0.00},
    {0.24, 0.24,-0.06,-0.28,-0.16, 0.16, 0.28, 0.06,-0.24,-0.24, 0.06, 0.28, 0.16,-0.16,-0.28,-0.06, 0.24, 0.24,-0.06,-0.28,-0.16, 0.16, 0.28, 0.06},
    {0.23, 0.23,-0.11,-0.29,-0.04, 0.27, 0.18,-0.18,-0.27, 0.04, 0.29, 0.11,-0.23,-0.23, 0.11, 0.29, 0.04,-0.27,-0.18, 0.18, 0.27,-0.04,-0.29,-0.11},
    {0.22, 0.22,-0.16,-0.26, 0.09, 0.28,-0.02,-0.29,-0.06, 0.27, 0.13,-0.24,-0.19, 0.19, 0.24,-0.13,-0.27, 0.06, 0.29, 0.02,-0.28,-0.09, 0.26, 0.16}
};
	
void procNoise(uint32_t u32Addr, uint32_t u32Cnt)
{
	int32_t sumval = 0;
	int32_t sumabs = 0;
    int32_t absval = 0;
    int32_t maxval = 0;
	
	int32_t i;
	int32_t j;
	
	int32_t u32BkAddr;
	int32_t u32BkData;
	
	memset((void*)&s_sVoiceaddrCtrlHandle, 0x0, sizeof(s_sVoiceaddrCtrlHandle));
	
	s_sVoiceaddrCtrlHandle.u32BegAddr = u32Addr;
	s_sVoiceaddrCtrlHandle.u32EndAddr = u32Addr + 4 * u32Cnt;
	s_sVoiceaddrCtrlHandle.u32CurAddr = u32Addr;
	
	s_sBackgroudCtrlHandle.midd = 0;
	s_sBackgroudCtrlHandle.nthr = 0;
	s_sBackgroudCtrlHandle.zthr = 0;
	s_sBackgroudCtrlHandle.sthr = 0;
	
	for(i = 0; i < VAD_BKGRO_CNT; i++)
    {
		u32BkAddr = s_sVoiceaddrCtrlHandle.u32CurAddr + 4 * i;
		u32BkData = Flash_Read(u32BkAddr);
        sumval += u32BkData;
    }

    s_sBackgroudCtrlHandle.midd = sumval / VAD_BKGRO_CNT;

    sumval = 0;
    for(i = 0; i < VAD_BKGRO_CNT; i += VAD_FRAME_LEN)
    {
    	for(j = 0; j < VAD_FRAME_LEN; j++)
	    {
		    u32BkAddr = s_sVoiceaddrCtrlHandle.u32CurAddr + 4 * i + 4 * j;
			u32BkData = Flash_Read(u32BkAddr);
			
			if(u32BkData > s_sBackgroudCtrlHandle.midd)
				absval = u32BkData - s_sBackgroudCtrlHandle.midd;
			else
                absval = s_sBackgroudCtrlHandle.midd - u32BkData;

			if(absval < 0)
			{
				printf("Error: procNoise midd=%d val=%d\n", s_sBackgroudCtrlHandle.midd, u32BkData);
			}
			
	        if(absval > maxval)
	            maxval = absval;
			
	        sumabs += absval;
	    }
	    sumval += maxval;
	}

    s_sBackgroudCtrlHandle.nthr = sumval / (VAD_BKGRO_CNT/VAD_FRAME_LEN) * VAD_NTHL_RATIO;
    s_sBackgroudCtrlHandle.sthr = sumabs / (VAD_BKGRO_CNT/VAD_FRAME_LEN) * VAD_STHL_RATIO;
    s_sBackgroudCtrlHandle.zthr = VAD_FRAME_LEN * VAD_ZTHL_RATIO / VAD_NTHL_RATIO;

    /*
	printf("ZHOUYANHUI: [BackGroud] Check\n");
    printf("s_sBackgroudCtrlHandle.midd = %d\n", s_sBackgroudCtrlHandle.midd);
    printf("s_sBackgroudCtrlHandle.nthr = %d\n", s_sBackgroudCtrlHandle.nthr);
    printf("s_sBackgroudCtrlHandle.sthr = %d\n", s_sBackgroudCtrlHandle.sthr);
    printf("s_sBackgroudCtrlHandle.zthr = %d\n", s_sBackgroudCtrlHandle.zthr);
    */
	
	s_sVoiceaddrCtrlHandle.u32CurAddr += 4 * VAD_BKGRO_CNT;
}

uint16_t cal_zeros(uint32_t u32EndAddr)
{
	int16_t  v_zeros = 0;
	int32_t  u32Addr = u32EndAddr - 4 * VAD_FRAME_LEN;
	int32_t  u32Data1;
	int32_t  u32Data2;

	while(u32Addr < u32EndAddr)
	{
		u32Data1 = Flash_Read(u32Addr);
		u32Data2 = Flash_Read((u32Addr + 4));
		if((u32Data1 - (s_sBackgroudCtrlHandle.nthr + s_sBackgroudCtrlHandle.midd)) > 0 && (u32Data2 + (s_sBackgroudCtrlHandle.nthr - s_sBackgroudCtrlHandle.midd)) < 0)
		{
			v_zeros++;
		}

		if((u32Data1 + (s_sBackgroudCtrlHandle.nthr - s_sBackgroudCtrlHandle.midd)) < 0 && (u32Data2 - (s_sBackgroudCtrlHandle.nthr + s_sBackgroudCtrlHandle.midd)) > 0)
		{
			v_zeros++;
		}
		
		u32Addr += 4;
	}

	return v_zeros;
}

uint32_t cal_sumabs(uint32_t u32EndAddr)
{
	uint32_t  v_sumabs = 0;
	uint32_t  u32Addr = u32EndAddr - 4 * VAD_FRAME_LEN;
	int32_t   u32Data;
	int32_t   u32AbsVal;

	while(u32Addr < u32EndAddr)
	{
		u32Data = Flash_Read(u32Addr);
		if(u32Data > s_sBackgroudCtrlHandle.midd)
			u32AbsVal = u32Data - s_sBackgroudCtrlHandle.midd;
		else
			u32AbsVal = s_sBackgroudCtrlHandle.midd - u32Data;
		
		if(u32AbsVal < 0)
			printf("Error: cal_sumabs\n");
		
		v_sumabs += u32AbsVal;
		u32Addr += 4;
	}

	return v_sumabs;
}

int16_t vad(void)
{
    uint32_t   u32Addr;
	uint32_t   zeros;
	uint32_t   sumabs;
	uint32_t   silence;
	int32_t    i32Ret = 0;
	
	s_sBoundaddrCtrlHandle.u32BegAddr = 0;
	s_sBoundaddrCtrlHandle.u32EndAddr = 0;
	
	u32Addr = s_sVoiceaddrCtrlHandle.u32CurAddr + 4 * VAD_FRAME_LEN;
	
	while(u32Addr < s_sVoiceaddrCtrlHandle.u32EndAddr)
	{
	    zeros  =  cal_zeros(u32Addr);
		sumabs =  cal_sumabs(u32Addr);
		
		if(zeros > s_sBackgroudCtrlHandle.zthr || sumabs > s_sBackgroudCtrlHandle.sthr)
		{
			if(!s_sBoundaddrCtrlHandle.u32BegAddr)
			{
				s_sBoundaddrCtrlHandle.u32BegAddr = u32Addr - 4 * VAD_FRAME_LEN;
			}
			silence = 0;
		}
		else
		{
			//printf("ZHOUYANHUI: i=%d zeros %d>%d sumabs %d>%d\n", i++, zeros, s_sBackgroudCtrlHandle.zthr, sumabs, s_sBackgroudCtrlHandle.sthr);
			if(s_sBoundaddrCtrlHandle.u32BegAddr)
			{
				if((u32Addr - s_sBoundaddrCtrlHandle.u32BegAddr) < 4 * (VAD_MINSP_CNT + VAD_FRAME_LEN))
				{
					s_sBoundaddrCtrlHandle.u32BegAddr  = 0;
					s_sBoundaddrCtrlHandle.u32EndAddr  = 0;
				}
				else
				{
					silence += VAD_FRAME_LEN;
					if(silence >= VAD_SILEN_CNT)
					{
						s_sBoundaddrCtrlHandle.u32EndAddr = u32Addr - 4 * silence;
						break;
					}
				}
			}
		}
	    u32Addr += 4 * VAD_FRAME_LEN;
	}
	/*
	printf("ZHOUYANHUI: [BackGroud] Check\n");
    printf("s_sBackgroudCtrlHandle.midd = %d\n", s_sBackgroudCtrlHandle.midd);
    printf("s_sBackgroudCtrlHandle.nthr = %d\n", s_sBackgroudCtrlHandle.nthr);
    printf("s_sBackgroudCtrlHandle.sthr = %d\n", s_sBackgroudCtrlHandle.sthr);
    printf("s_sBackgroudCtrlHandle.zthr = %d\n", s_sBackgroudCtrlHandle.zthr);
    */
	
	if(!s_sBoundaddrCtrlHandle.u32EndAddr)
	{
		printf("Vad Check Result: FAIL\n");
	    printf("BegAddr = %d\n", s_sBoundaddrCtrlHandle.u32BegAddr);
	    printf("EndAddr = %d\n", s_sBoundaddrCtrlHandle.u32EndAddr);
		i32Ret = -1;
	}
	else
	{
		printf("Vad Check Result: SUCCESS\n");
	    printf("BegAddr = %d\n", s_sBoundaddrCtrlHandle.u32BegAddr);
	    printf("EndAddr = %d\n", s_sBoundaddrCtrlHandle.u32EndAddr);
	}
		
	return i32Ret;
}

void add_hamm(float *f32FrmData)
{
	int16_t  i;
	float    temp;

	for(i=1; i < VAD_FRAME_LEN; i++)
	{
		temp = (f32FrmData[i] - f32FrmData[i-1]) * MFC_PRE_WTH;
		//i16FrmData[i] = (int16_t)(temp * ((1 - 0.46f) - 0.46f * cos(2 * PI * i / (VAD_FRAME_LEN -1))) /** 10*/);
		f32FrmData[i] = (int16_t)(temp * MFC_HAM_FRAMES[i] * 100);
	}
}

complex add(complex a,complex b)
{
    complex c;
    c.real = a.real + b.real;
    c.img  = a.img  + b.img;

    return c;
}

complex sub(complex a,complex b)
{
    complex c;
    c.real = a.real - b.real;
    c.img  = a.img  - b.img;

    return c;
}

complex mul(complex a,complex b)
{
    complex c;
    c.real = a.real * b.real - a.img  * b.img;
    c.img  = a.img  * b.real + a.real * b.img;

    return c;
}
/*
void Reverse(complex* data, int16_t N)
{
	int16_t  i;
	int16_t  j;
	int16_t  k;
	int16_t  t;
	int16_t  m;
	int16_t  rank = 0;
	complex  tmp;

    for(m = 1; m < N; m <<= 1)
    {
    	rank++;
    }

    for(i = 0; i < N; i++)
    {
        k = i;
        j = 0;

        for(t = 0; t < rank; t++)
        {
            j <<= 1;
            j  |= (k&1);
            k >>= 1;
        }

        if(j > i)
        {
        	tmp.real = (data + i)->real;
        	tmp.img  = (data + i)->img;

        	(data + i)->real = (data + j)->real;
        	(data + i)->img  = (data + j)->img;
        	(data + j)->real = tmp.real;
        	(data + j)->img  = tmp.img;
        }
    }
}*/
void Reverse(complex* data, float* realArr)
{
	uint16_t i;
	
	for(i = 0; i < MFC_FFT_PRC; i++)
	{
		if(MFC_BIT_REVSER[i] < MFC_FFT_PRC)
		{
			(data + i)->real = *(realArr + MFC_BIT_REVSER[i]);
		}
	}
}
/*
complex get_Wn(int16_t k, int16_t N)
{
	complex wn;
	wn.real = cos(2 * PI / N * k);
	wn.img  = -sin(2 * PI / N * k);

	return wn;
}
*/

void calc_fft(complex* data, float* realArr, int16_t N)
{
	int i;
	int j;
	int k;
	int l;
	int m = 0;
	
	complex wn;
	complex wx;
	complex top;
	complex bot;

	Reverse(data, realArr);

	for(i = 0; i < MFC_FFT_POW; i++)
	{
		l = 1 << i;
		for(j = 0; j < N; j += 2 * l)
		{
			for(k = 0; k < l; k++)
			{	
				wn.real = MFC_FFT_COFFIC[m + 2 * k];
				wn.img  = MFC_FFT_COFFIC[m + 2 * k + 1];
				
				wx  = mul(*(data + j + k + l), wn);
				
				top = add(*(data + j + k), wx);
				bot = sub(*(data + j + k), wx);
				
				*(data + j + k) = top;
				*(data + j + k + l) = bot;
			}
		}
		m += 2 * l;
	}	
}

float get_cent(float* v_buf, const int16_t low, const int16_t mid, const int16_t hig)
{
	int16_t i;
	float   pow_cen = 0;

	for(i = low; i < hig; i++)
	{
		if(mid - i > 0)
		{
			pow_cen += (*(v_buf+i) * ((i - low) / (mid - low)));
		}
		else if(mid - i < 0)
		{
			pow_cen += (*(v_buf+i) * ((hig - i) / (hig - mid)));
		}
		else
		{
			pow_cen += *(v_buf+i);
		}
	}
	//printf("%d ", pow_cen);

	return pow_cen;
}

void add_trig(float* v_fft, const int16_t* v_tricen, float* v_pow)
{
	uint16_t i;
	
	for(i=0; i< MFC_TRI_NUM; i++)
	{
		if(i == 0)
		{
			*(v_pow+i) = get_cent(v_fft, 0, *(v_tricen+i), *(v_tricen+i+1));
		}
		else if(i == MFC_TRI_NUM - 1)
		{
			*(v_pow+i) = get_cent(v_fft, *(v_tricen+i-1), *(v_tricen+i), MFC_FRQ_MAX);
		}
		else
		{
			*(v_pow+i) = get_cent(v_fft, *(v_tricen+i-1), *(v_tricen+i), *(v_tricen+i+1));
		}
	}
}

void get_loge(float* v_buf)
{
	uint16_t i;
	
	for(i=0; i < MFC_TRI_NUM; i++)
	{
		//printf("bef:%d ", *(v_buf+i));
		*(v_buf+i) = (uint32_t)(log((float)(*(v_buf+i))) /**100*/);
		//printf("aft:%d ", *(v_buf+i));
	}
}

void get_coef(float* v_buf, uint32_t* v_cos)
{
	uint16_t i;
	uint16_t j;
	float    f32cos;
	
	for(i = 0; i < MFC_ORD_NUM; i++)
	{
		f32cos = 0;
		for(j = 0; j < MFC_TRI_NUM; j++)
		{
			//*(v_cos+i) += *(v_buf+j) * sqrt(2.0f/MFC_TRI_NUM) * cos((j-0.5f) * i * PI / MFC_TRI_NUM);
			f32cos += (*(v_buf+j) * MFC_COS_TRGCNT[i][j]);
		}
		*(v_cos+i) = f32cos;

		//printf(" mfcc:%d * ", *(v_cos+i));
	}
}

int16_t mfcc(uint16_t u16Cmd)
{
	uint32_t    u32Addr;
	uint32_t    u32FrmAddr;
//	uint32_t    u32FrmData;
	uint32_t    u32MfcAddr;
	
	float       f32FrqData;
	complex*    complxFftArr = 0;
	float*      f32FrqArr    = 0;
	
	float       f32TRGCenArr[MFC_TRI_NUM];
	uint32_t    u32MFCCFgArr[MFC_ORD_NUM];
	
	int16_t     i;
	int16_t     i16Ret = 0;
	
	memset((void*)&s_sBlockaddrCtrlHandle, 0x0, sizeof(s_sBlockaddrCtrlHandle));
	s_sBlockaddrCtrlHandle.cmd     = u16Cmd;
	s_sBlockaddrCtrlHandle.frames  = 0;
	if(s_sBlockaddrCtrlHandle.cmd == DATA_FLASH_MFCCTG_MAX)
	{
		s_sBlockaddrCtrlHandle.begaddr = DATA_FLASH_MFCCRG_BEG;
	    s_sBlockaddrCtrlHandle.endaddr = s_sBlockaddrCtrlHandle.begaddr + DATA_FLASH_VALBUF_SIZ;
	}
	else
	{
	    s_sBlockaddrCtrlHandle.begaddr = DATA_FLASH_MFCCTG_BEG + s_sBlockaddrCtrlHandle.cmd * DATA_FLASH_VALBUF_SIZ;
	    s_sBlockaddrCtrlHandle.endaddr = s_sBlockaddrCtrlHandle.begaddr + DATA_FLASH_VALBUF_SIZ;
	}
	u32MfcAddr = s_sBlockaddrCtrlHandle.begaddr + 8;
	
	Flash_Erase(s_sBlockaddrCtrlHandle.begaddr, s_sBlockaddrCtrlHandle.endaddr);
	
	u32Addr = s_sBoundaddrCtrlHandle.u32BegAddr + 4 * VAD_FRAME_LEN;
	while(u32Addr < s_sBoundaddrCtrlHandle.u32EndAddr)
	{
		memset((void*)f32RecFrmData, 0x0, sizeof(f32RecFrmData));
		for(i = 0; i < VAD_FRAME_LEN; i++)
		{
			u32FrmAddr = u32Addr - 4 * (VAD_FRAME_LEN - i);
			//u32FrmData = Flash_Read(u32FrmAddr);
			f32RecFrmData[i] = (float)Flash_Read(u32FrmAddr);
			//printf("Before hamm: %d \n", f32RecFrmData[i]);
		}
		
		add_hamm((float*)f32RecFrmData);
		
		complxFftArr = (complex*)FFT_MEM_BEG;
	    memset((void*)complxFftArr, 0x0, sizeof(complex) * MFC_FFT_PRC);
		
		calc_fft(complxFftArr, (float*)f32RecFrmData, MFC_FFT_PRC);

		f32FrqArr = (float*)FRQ_MEM_BEG;
		memset((void*)f32FrqArr, 0x0, sizeof(float) * MFC_FRQ_MAX);
		
		for(i=0; i < MFC_FRQ_MAX; i++)
        {
			f32FrqData  = pow(complxFftArr[i].real, 2) + pow(complxFftArr[i].img, 2);
    	    f32FrqArr[i] = sqrt(f32FrqData);
			//optimize[f32FrqArr]
			f32FrqArr[i] = f32FrqData; 
        }
		
		//optimize[memset complxFftArr 0x0]
	    //memset((void*)complxFftArr, 0x0, sizeof(complex) * MFC_FFT_PRC);
		complxFftArr = 0;
		
		/* optimize[f32FrqArr]
		for(i=0; i < MFC_FRQ_MAX; i++)
        {
    	    f32FrqArr[i] *= f32FrqArr[i];
        }
		*/
		
		memset((void*)f32TRGCenArr, 0x0, sizeof(f32TRGCenArr));
		add_trig(f32FrqArr, MFC_TRG_CENTER, f32TRGCenArr);
		
		//optimize[memset f32FrqArr 0x0]
		//memset((void*)f32FrqArr, 0x0, sizeof(float) * MFC_FRQ_MAX);
		f32FrqArr = 0;
		
		get_loge(f32TRGCenArr);
		
		memset((void*)u32MFCCFgArr, 0x0, sizeof(uint32_t) * MFC_ORD_NUM);
		get_coef(f32TRGCenArr, u32MFCCFgArr);
		
		/*check Mfcc
		printf("MFCC Check Frame[%d]\n", s_sBlockaddrCtrlHandle.frames);
		for(i = 0; i < MFC_ORD_NUM; i++)
		    printf("%d ", u32MFCCFgArr[i]);
		printf("\n");
		*/

		u32Addr += 4 * VAD_FRAME_MOV;
		
		//Flash 
		s_sBlockaddrCtrlHandle.frames++;
		for(i = 0; i < MFC_ORD_NUM; i++)
		{
			u32MfcAddr += 4;
			if(u32MfcAddr < s_sBlockaddrCtrlHandle.endaddr)
			{
				Flash_Write4B(u32MfcAddr, u32MFCCFgArr[i]);
			}
			else
			{
				i16Ret = -1;
				break;
			}
		}
	}	
	
	if(i16Ret < 0)
	{
		Flash_Erase(s_sBlockaddrCtrlHandle.begaddr, s_sBlockaddrCtrlHandle.endaddr);
		printf("Cmd[%d] mfcc storage overflow\n", s_sBlockaddrCtrlHandle.cmd);
		printf("Cmd[%d] mfcc storage frames %d\n", s_sBlockaddrCtrlHandle.cmd, s_sBlockaddrCtrlHandle.frames);
		printf("Cmd[%d] mfcc storage need %d B\n", s_sBlockaddrCtrlHandle.cmd, (s_sBlockaddrCtrlHandle.frames * MFC_ORD_NUM * 4));
	}
	else
	{
	    Flash_Write4B(s_sBlockaddrCtrlHandle.begaddr, s_sBlockaddrCtrlHandle.cmd);
	    Flash_Write4B((s_sBlockaddrCtrlHandle.begaddr + 4), s_sBlockaddrCtrlHandle.frames);
		printf("Cmd[%d] mfcc process SUCCESS\n", s_sBlockaddrCtrlHandle.cmd);
		printf("Cmd[%d] mfcc storage frames %d\n", s_sBlockaddrCtrlHandle.cmd, s_sBlockaddrCtrlHandle.frames);
		printf("Cmd[%d] mfcc storage need %d B\n", s_sBlockaddrCtrlHandle.cmd, (s_sBlockaddrCtrlHandle.frames * MFC_ORD_NUM * 4));
	}
	
	return i16Ret;
}

int16_t Record_Process(uint32_t u32RecAddr, uint16_t u16RecCnt, uint16_t u16Cmd)
{
	int16_t  i16Ret = 0;
	
    // Noise Process
	procNoise(u32RecAddr, u16RecCnt);
				
	// Vad Process
	i16Ret = vad();
	if(i16Ret < 0)
	{
		printf("Cmd[%d] Record Process vad fail\n", u16Cmd);
		return -1;
	}
	
	// Mfcc Process
	i16Ret = mfcc(u16Cmd);
	if(i16Ret < 0)
	{
		printf("Cmd[%d] Record Process mfcc fail", u16Cmd);
		return -1;
	}
	
	return i16Ret;
}

float get_frmdis(uint32_t v_frm1, uint32_t v_frm2)
{
	float   dis = 0;
	float   dif = 0;
	int32_t i;
	
	uint32_t u32FrmAddr1 = v_frm1;
	uint32_t u32FrmAddr2 = v_frm2;
	uint32_t u32FrmData1;
	uint32_t u32FrmData2;

	for (i = 0; i < MFC_ORD_NUM; i++)
	{
		u32FrmAddr1 += 4 * i;
		u32FrmAddr2 += 4 * i;
		
		u32FrmData1 = Flash_Read(u32FrmAddr1);
		u32FrmData2 = Flash_Read(u32FrmAddr2);
		
		dif  = u32FrmData1 - u32FrmData2;
		dis += pow(dif, 2);
	}

	dis = sqrt(dis);
	return dis;
}

float get_frmval(uint32_t u32Addr)
{
	float   dis = 0;
	float   dif = 0;
	int32_t i;
	
	uint32_t u32FrmAddr = u32Addr;
	uint32_t u32FrmData;

	for (i = 0; i < MFC_ORD_NUM; i++)
	{
		u32FrmAddr += 4 * i;
		u32FrmData = Flash_Read(u32FrmAddr);
		
		dif  = u32FrmData;
		dis += pow(dif, 2);
	}

	dis = sqrt(dis);
	return dis;
}

float get_dtwdis(uint32_t u32SmpBlkAddr, uint32_t u32TemBlkAddr)
{
	float   dtwdis = 0;
	int16_t i      = 1;
	int16_t j      = 1;
	int16_t k;

	DIRECTION dir;
	float     dis[3];
	int32_t   min;
	
	uint32_t  u32SmpAddr = u32SmpBlkAddr;
	uint32_t  u32TemAddr = u32TemBlkAddr;
	uint32_t  u32SmpFrms = Flash_Read((u32SmpAddr + 4));
	uint32_t  u32TemFrms = Flash_Read((u32TemAddr + 4));
	
	uint32_t  u32SmpBase = u32SmpAddr + 8;
	uint32_t  u32TemBase = u32TemAddr + 8;
	
	uint32_t  u32SmpFArr0;
	uint32_t  u32TemFArr0;
	uint32_t  u32SmpFArr1;
	uint32_t  u32TemFArr1;
	
	if((u32SmpFrms > u32TemFrms * 2) || (u32SmpFrms < u32TemFrms / 2))
	{
		return MFC_MAX_DIS;
	}

	dtwdis = get_frmdis(u32SmpBase, u32TemBase);
	while(i < u32SmpFrms && j < u32TemFrms)
	{
		u32SmpFArr0 = u32SmpBase + (i - 1) * MFC_ORD_NUM * 4;
		u32TemFArr0 = u32TemBase + (j - 1) * MFC_ORD_NUM * 4;
		u32SmpFArr1 = u32SmpBase + i * MFC_ORD_NUM * 4;
		u32TemFArr1 = u32TemBase + j * MFC_ORD_NUM * 4;
		
		dis[E_DIRCT_RIGHT]   = get_frmdis(u32SmpFArr1, u32TemFArr0);
		dis[E_DIRCT_UP]      = get_frmdis(u32SmpFArr0, u32TemFArr1);
		dis[E_DIRCT_INCLINE] = get_frmdis(u32SmpFArr1, u32TemFArr1);

		min = dis[E_DIRCT_RIGHT];
		dir = E_DIRCT_RIGHT;

		for(k = 1; k < 3; k++)
		{
			if(min > dis[k])
			{
				min = dis[k];
				dir = (DIRECTION)k;
			}
		}

		switch(dir)
		{
		    case E_DIRCT_RIGHT:
			    i++;
			    break;
		    case E_DIRCT_UP:
			    j++;
			    break;
		    case E_DIRCT_INCLINE:
			    i++;
			    j++;
			    break;
		    default:
			    break;
		}

		dtwdis += min;
	}

	
	while(i < u32SmpFrms)
	{
		u32SmpFArr0 = u32SmpBase + (i - 1) * MFC_ORD_NUM * 4;
		u32TemFArr0 = u32TemBase + (j - 1) * MFC_ORD_NUM * 4;
		u32SmpFArr1 = u32SmpBase + i * MFC_ORD_NUM * 4;
		u32TemFArr1 = u32TemBase + j * MFC_ORD_NUM * 4;
		
		//dtwdis += get_frmdis(u32SmpFArr1, u32TemFArr0);
		dtwdis += get_frmval(u32SmpFArr1);
		i++;
	}
	
    
	while(j < u32TemFrms)
	{
		u32SmpFArr0 = u32SmpBase + (i - 1) * MFC_ORD_NUM * 4;
		u32TemFArr0 = u32TemBase + (j - 1) * MFC_ORD_NUM * 4;
		u32SmpFArr1 = u32SmpBase + i * MFC_ORD_NUM * 4;
		u32TemFArr1 = u32TemBase + j * MFC_ORD_NUM * 4;
		
		//dtwdis += get_frmdis(u32SmpFArr0, u32TemFArr1);
		dtwdis += get_frmval(u32TemFArr1);
		j++;
	}

	return dtwdis;
}

int16_t dtw(float* mindtw)
{
	uint32_t u32SmpAddr;
	uint32_t u32TemAddr;
	int32_t  i32TemComd;
	uint32_t u32TemFrms;
	
	uint16_t i;
	int16_t  i16RetCmd;
	
    float    f32DtwArr[DATA_FLASH_MFCCTG_MAX];
	float    f32DtwMin;
	
	memset((void*)f32DtwArr, 0x0, sizeof(f32DtwArr));
	u32SmpAddr = DATA_FLASH_MFCCRG_BEG;
	
	for(i = 0; i < DATA_FLASH_MFCCTG_MAX; i++)
	{
		u32TemAddr = DATA_FLASH_MFCCTG_BEG + i * DATA_FLASH_VALBUF_SIZ;
		i32TemComd = Flash_Read(u32TemAddr);
		u32TemFrms = Flash_Read((u32TemAddr + 4));
		
		if(i32TemComd >= 0)
		{
			f32DtwArr[i] = get_dtwdis(u32SmpAddr, u32TemAddr) / u32TemFrms;
		}
		else
		{
			f32DtwArr[i] = MFC_MAX_DIS;
		}
	}
	
	f32DtwMin = MFC_MAX_DIS;
	i16RetCmd = MFC_INV_CMD;
	for(i = 0; i < DATA_FLASH_MFCCTG_MAX; i++)
	{
		if(f32DtwArr[i] == MFC_MAX_DIS)
		{
			continue;
		}

		if(f32DtwMin == MFC_MAX_DIS)
		{
			f32DtwMin = f32DtwArr[i];
			i16RetCmd = i;
		}

		if(f32DtwMin > f32DtwArr[i])
		{
			f32DtwMin = f32DtwArr[i];
			i16RetCmd = i;
		}

		printf("Compare Cmd[%d] Dtw[%f] \n", i, f32DtwArr[i]);
	}
	*mindtw = f32DtwMin;

    //printf("dtwmin = %f\n", f32DtwMin);
	return i16RetCmd;
}
	
int16_t Recognize_Process(uint32_t u32RecAddr, uint16_t u16RecCnt, uint16_t u16Cmd)
{
	int16_t  i16Ret = 0;
	float    dtwLen = 0;
	
    // Noise Process
	procNoise(u32RecAddr, u16RecCnt);
				
	// Vad Process
	i16Ret = vad();
	if(i16Ret < 0)
	{
		printf("Cmd[%d] Record Process vad fail\n", u16Cmd);
		return -1;
	}
	
	// Mfcc Process
	i16Ret = mfcc(u16Cmd);
	if(i16Ret < 0)
	{
		printf("Cmd[%d] Record Process mfcc fail\n", u16Cmd);
		return -1;
	}
	
	i16Ret = dtw(&dtwLen);
	printf("Cmd[%d]  ", i16Ret);
	printf("Dtw[%f]\n", dtwLen);
	
	return i16Ret;
}























